package it.gabrielebologna.grandanticheat.check.exploit;

import org.bukkit.entity.Player;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;

import it.gabrielebologna.grandanticheat.GrandAntiCheat;
import it.gabrielebologna.grandanticheat.check.Check;
import it.gabrielebologna.grandanticheat.player.PlayerData;

public class Disabler extends Check
{
	private PacketType[] packetTypes = new PacketType[] {PacketType.Play.Client.KEEP_ALIVE, PacketType.Play.Client.TRANSACTION};
	
	public Disabler()
	{
		super("Disabler");
		
		Check chick = this;
		
		ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(GrandAntiCheat.getPlugin(), packetTypes)
        {
            public void onPacketReceiving(final PacketEvent event)
            {       	
            	Player player = event.getPlayer();
            	PlayerData playerData = GrandAntiCheat.getPlayerDataManager().getPlayerData(player);
            	PacketContainer packet = event.getPacket();
            	
            	if (!playerData.canBeChecked())
            	{
            		return;
            	}
            	
            	if (chick.isToggled("keep-alive"))
            	{
            		if (packet.getType().equals(PacketType.Play.Client.KEEP_ALIVE))
            		{
                        long now = System.currentTimeMillis();
                        long last = playerData.getLast();
                        playerData.setLast(now);

                        double diff = now-last;

                        if (diff < 10)
                        {
                        	playerData.setVerbose39(playerData.getVerbose39() + 1);
                        	
                            if (playerData.getVerbose39() > 2)
                            {
                            	GrandAntiCheat.getFlagManager().flagPlayer(player, chick, "Type A - Keep alive", "Ping: " + playerData.getPing() + ", TPS: " + GrandAntiCheat.getLagManager().getTPS(), true);
                            }
                        }
                        else
                        {
                        	playerData.setVerbose39(playerData.getVerbose39() > 0 ? playerData.getVerbose39() - 1 : 0);
                        }
            		}
            	}
            }
        });
	}
	
	@Override
	public void setup()
	{
		if (GrandAntiCheat.isDebugMode())
		{
			this.getSettings().addDefault("keep-alive", true);
			this.getSettings().addDefault("keep-transaction", true);
		}
	}
}