package it.gabrielebologna.grandanticheat.check.exploit;

import java.util.ArrayList;

import org.bukkit.event.EventHandler;
import org.bukkit.event.player.PlayerCommandPreprocessEvent;

import com.comphenix.packetwrapper.WrapperPlayClientTabComplete;
import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;

import it.gabrielebologna.grandanticheat.GrandAntiCheat;
import it.gabrielebologna.grandanticheat.check.Check;

public class PluginFinder extends Check
{
	private ArrayList<String> commands;
	
	public PluginFinder()
	{
		super("PluginFinder");
		
		commands = new ArrayList<String>();
		commands.add("/pl");
		commands.add("/plugins");
		commands.add("/about");
		commands.add("/version");
		commands.add("/help");
		commands.add("/ver");
		commands.add("/?");
		commands.add("/essentials:help");
		commands.add("/icanhasbukkit");
		commands.add("/bungee");
		commands.add("/op");
		
		ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(GrandAntiCheat.getPlugin(), PacketType.Play.Client.TAB_COMPLETE)
        {
            public void onPacketReceiving(final PacketEvent event)
            {    	
            	PacketContainer packet = event.getPacket();
            	WrapperPlayClientTabComplete wrapperPlayClientTabComplete = new WrapperPlayClientTabComplete(packet);
            	String cmd = wrapperPlayClientTabComplete.getInput();
            	cmd = cmd.toLowerCase();
            	cmd = cmd.replace(" ", "");
            	
            	if (cmd.equals("/"))
            	{
            		event.setCancelled(true);
            		return;
            	}
            	
        		for (String cmder: commands)
        		{
        			if (cmder.equalsIgnoreCase(cmd))
        			{
        				event.setCancelled(true);
        				return;
        			}
        		}
            }
        });
	}
	
	@EventHandler
	public void onSendMessage(PlayerCommandPreprocessEvent event)
	{
		String message = event.getMessage();
		message = message.toLowerCase();
		message = message.replace(" ", "");
		
		if (!message.startsWith("/"))
		{
			message = "/" + message;
		}
		
		for (String cmd: commands)
		{
			if (cmd.equalsIgnoreCase(message) || message.startsWith(cmd))
			{
				event.setCancelled(true);
				return;
			}
		}
		
		if (message.startsWith("/bukkit:") || message.startsWith("/paper:") || message.startsWith("/taco:") || message.startsWith("/spigot:") || message.startsWith("/minecraft:") || message.startsWith("/skin"))
		{
			event.setCancelled(true);
			return;
		}
	}
}